<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend Flow - Ll√©vateloExpress</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test Frontend Flow - Ll√©vateloExpress</h1>
        
        <div class="test-section">
            <h3>üìä Datos de Prueba</h3>
            <div id="testData"></div>
        </div>
        
        <div class="test-section">
            <h3>üîó URLs Generadas</h3>
            <button class="button" onclick="generateTestURLs()">Generar URLs de Prueba</button>
            <div id="urlResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üß™ Pruebas de Parsing</h3>
            <button class="button" onclick="testURLParsing()">Probar Parsing URLs</button>
            <div id="parsingResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üåê Test Navegaci√≥n</h3>
            <button class="button" onclick="testNavigation()">Ir a Solicitud con Datos</button>
            <button class="button" onclick="openDebugConsole()">Abrir Debug Console</button>
        </div>
        
        <div class="test-section">
            <h3>üìù Debug Logs</h3>
            <div id="debugLogs"></div>
            <button class="button" onclick="refreshLogs()">Actualizar Logs</button>
            <button class="button" onclick="clearLogs()">Limpiar Logs</button>
        </div>
    </div>

    <script>
        // Datos de prueba conocidos
        const testCalculationData = {
            mode: 'credito',
            financing_plan_id: 5,
            calculation: {
                vehicle_value: 15000,
                down_payment_percentage: 35,
                down_payment_amount: 5250,
                financed_amount: 9750,
                term_months: 24,
                payment_frequency: 'monthly',
                payment_amount: 406.25,
                total_cost: 15000,
                first_payment_date: '01/07/2025',
                payoff_date: '22/05/2027'
            },
            product: {
                id: 5,
                name: 'Suzuki GN 125',
                brand: 'Suzuki',
                price: 15000
            },
            mode_data: {
                name: 'Cr√©dito Inmediato',
                type: 'credito'
            }
        };

        function init() {
            displayTestData();
            refreshLogs();
        }

        function displayTestData() {
            document.getElementById('testData').innerHTML = `
                <div class="result">
                    <strong>Datos de c√°lculo de prueba:</strong><br>
                    ${JSON.stringify(testCalculationData, null, 2)}
                </div>
            `;
        }

        function generateTestURLs() {
            const results = document.getElementById('urlResults');
            
            try {
                // M√©todo 1: Como lo hace el calculador actual
                const params1 = new URLSearchParams({
                    mode: testCalculationData.mode,
                    calculation: JSON.stringify(testCalculationData)
                });
                const url1 = `solicitud-financiamiento.html?${params1.toString()}`;
                
                // M√©todo 2: URL simplificada
                const params2 = new URLSearchParams({
                    mode: testCalculationData.mode,
                    product_id: testCalculationData.product.id,
                    plan_id: testCalculationData.financing_plan_id,
                    price: testCalculationData.calculation.vehicle_value,
                    down_payment: testCalculationData.calculation.down_payment_amount
                });
                const url2 = `solicitud-financiamiento.html?${params2.toString()}`;
                
                results.innerHTML = `
                    <div class="result success">
                        <strong>URL M√©todo 1 (Actual):</strong><br>
                        Longitud: ${url1.length} caracteres<br>
                        <a href="${url1}" target="_blank">${url1.substring(0, 100)}...</a>
                    </div>
                    <div class="result success">
                        <strong>URL M√©todo 2 (Simplificada):</strong><br>
                        Longitud: ${url2.length} caracteres<br>
                        <a href="${url2}" target="_blank">${url2}</a>
                    </div>
                `;
                
                // Guardar URLs para pruebas
                window.testURL1 = url1;
                window.testURL2 = url2;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }

        function testURLParsing() {
            const results = document.getElementById('parsingResults');
            
            if (!window.testURL1) {
                results.innerHTML = '<div class="result error">Primero genera las URLs de prueba</div>';
                return;
            }
            
            try {
                // Extraer par√°metros de la URL de prueba
                const url = new URL(window.testURL1, window.location.origin);
                const urlParams = new URLSearchParams(url.search);
                const calculationParam = urlParams.get('calculation');
                const modeParam = urlParams.get('mode');
                
                let parseResults = `
                    <div class="result">
                        <strong>Par√°metros extra√≠dos:</strong><br>
                        Mode: ${modeParam}<br>
                        Calculation length: ${calculationParam ? calculationParam.length : 0} caracteres
                    </div>
                `;
                
                if (calculationParam) {
                    // Test 1: Parsing directo
                    try {
                        const directParsed = JSON.parse(calculationParam);
                        parseResults += `
                            <div class="result success">
                                <strong>‚úÖ Parsing Directo: EXITOSO</strong><br>
                                Producto: ${directParsed.product?.name || 'N/A'}<br>
                                Precio: $${directParsed.calculation?.vehicle_value || 'N/A'}
                            </div>
                        `;
                    } catch (e) {
                        parseResults += `
                            <div class="result error">
                                <strong>‚ùå Parsing Directo: FALL√ì</strong><br>
                                Error: ${e.message}
                            </div>
                        `;
                    }
                    
                    // Test 2: Parsing con decodeURIComponent
                    try {
                        const decoded = decodeURIComponent(calculationParam);
                        const decodedParsed = JSON.parse(decoded);
                        parseResults += `
                            <div class="result success">
                                <strong>‚úÖ Parsing con decodeURIComponent: EXITOSO</strong><br>
                                Producto: ${decodedParsed.product?.name || 'N/A'}<br>
                                Precio: $${decodedParsed.calculation?.vehicle_value || 'N/A'}
                            </div>
                        `;
                    } catch (e) {
                        parseResults += `
                            <div class="result error">
                                <strong>‚ùå Parsing con decodeURIComponent: FALL√ì</strong><br>
                                Error: ${e.message}
                            </div>
                        `;
                    }
                }
                
                results.innerHTML = parseResults;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">Error en test: ${error.message}</div>`;
            }
        }

        function testNavigation() {
            if (!window.testURL1) {
                alert('Primero genera las URLs de prueba');
                return;
            }
            
            // Guardar datos de prueba en localStorage para debugging
            localStorage.setItem('test_navigation_start', new Date().toISOString());
            localStorage.setItem('test_calculation_data', JSON.stringify(testCalculationData));
            
            // Navegar con datos
            window.location.href = window.testURL1;
        }

        function openDebugConsole() {
            alert('Debug Console: Abre las DevTools del navegador (F12) para ver los logs de FrontendDebugger');
        }

        function refreshLogs() {
            const logsDiv = document.getElementById('debugLogs');
            
            try {
                const logs = localStorage.getItem('debug_logs');
                if (logs) {
                    const parsedLogs = JSON.parse(logs);
                    const recentLogs = parsedLogs.slice(-10); // √öltimos 10 logs
                    
                    let logHTML = '';
                    recentLogs.forEach(log => {
                        logHTML += `
                            <div class="result">
                                <strong>${log.timestamp}</strong> [${log.page}]<br>
                                ${log.message}<br>
                                ${log.data ? JSON.stringify(log.data, null, 2) : ''}
                            </div>
                        `;
                    });
                    
                    logsDiv.innerHTML = logHTML || '<div class="result">No hay logs disponibles</div>';
                } else {
                    logsDiv.innerHTML = '<div class="result">No hay logs en localStorage</div>';
                }
            } catch (error) {
                logsDiv.innerHTML = `<div class="result error">Error cargando logs: ${error.message}</div>`;
            }
        }

        function clearLogs() {
            localStorage.removeItem('debug_logs');
            refreshLogs();
        }

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 